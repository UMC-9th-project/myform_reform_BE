name: PR Docker Build & Push

on:
  push:
    branches:
      - develop
      - main

jobs:
  build-on-a-server:
    runs-on: ubuntu-latest

    steps:
      - name: SSH to A server and build docker image
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.A_SERVER_HOST }}
          username: ${{ secrets.A_SERVER_USER }}
          key: ${{ secrets.A_SERVER_SSH_KEY }}
          port: 11857
          script: |
            set -e

            mkdir -p /tmp/.docker
            export DOCKER_CONFIG=/tmp/.docker

            echo "üì¶ Move to project directory"
            cd /Users/develop_user/workspace/dev/myform_reform

            echo "üîÑ Fetch latest code"
            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            echo "üê≥ Docker login"
            /usr/local/bin/docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

            echo "üèó Docker build & push"
            /usr/local/bin/docker buildx build --platform linux/amd64 -t seoki/myform_reform:${{ github.ref_name }} --push .
