name: PR Docker Build & Push

on:
  push:
    branches:
      - develop
      - main

jobs:
  build-on-a-server:
    runs-on: ubuntu-latest

    steps:
      - name: SSH to A server and build docker image
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.A_SERVER_HOST }}
          username: ${{ secrets.A_SERVER_USER }}
          key: ${{ secrets.A_SERVER_SSH_KEY }}
          script: |
            set -e

            echo "ğŸ“¦ Move to project directory"
            cd /Users/develop_user/workspace/dev/myform_reform

            echo "ğŸ”„ Fetch latest code"
            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            echo "ğŸ³ Docker login"
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

            echo "ğŸ— Docker build & push"
            docker buildx build --platform linux/amd64 -t seoki/myform_reform:${{ github.ref_name }} --push .
